From 870add1c1a678b3781edeae7129299b22a977a8d Mon Sep 17 00:00:00 2001
From: John Regehr <regehr@cs.utah.edu>
Date: Sat, 23 Feb 2019 09:51:51 -0700
Subject: [PATCH 29/31] patch from Mingwandroid to update to LLVM 7

---
 .travis.yml                            |  6 +++---
 INSTALL.md                             |  3 +--
 clang_delta/ExpressionDetector.cpp     | 18 +++++++++---------
 clang_delta/RemoveUnusedEnumMember.cpp | 10 ++++------
 configure                              |  6 +++---
 configure.ac                           |  2 +-
 scripts/travis_deps.sh                 | 16 ++++++++--------
 7 files changed, 29 insertions(+), 32 deletions(-)

diff --git a/.travis.yml b/.travis.yml
index 5a8727f..2014b23 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -17,9 +17,9 @@ before_install:
   - sudo scripts/travis_deps.sh
 
 script: >
-  CXX=/usr/lib/llvm-6.0/bin/clang++
-  CC=/usr/lib/llvm-6.0/bin/clang
-  ./configure --with-llvm=/usr/lib/llvm-6.0 &&
+  CXX=/usr/lib/llvm-7/bin/clang++
+  CC=/usr/lib/llvm-7/bin/clang
+  ./configure --with-llvm=/usr/lib/llvm-7 &&
   make -j2 &&
   make check
 
diff --git a/INSTALL.md b/INSTALL.md
index be38721..afbb832 100644
--- a/INSTALL.md
+++ b/INSTALL.md
@@ -45,8 +45,7 @@ manager:
 
 * [Flex](http://flex.sourceforge.net/)
 
-* [LLVM/Clang 6.0.0](http://llvm.org/releases/download.html#6.0.0)
-
+* [LLVM/Clang 7.0.0](http://llvm.org/releases/download.html#7.0.0)
   (No need to compile it: the appropriate "Clang binaries" package is
   all you need.  If you use one of the binary packages, you may need
   to install additional packages that the binary package depends on.
diff --git a/clang_delta/ExpressionDetector.cpp b/clang_delta/ExpressionDetector.cpp
index dd77068..62d860f 100644
--- a/clang_delta/ExpressionDetector.cpp
+++ b/clang_delta/ExpressionDetector.cpp
@@ -78,15 +78,15 @@ private:
 };
 
 void IncludesPPCallbacks::InclusionDirective(SourceLocation HashLoc,
-                                        const Token &/*IncludeTok*/,
-                                        StringRef FileName,
-                                        bool /*IsAngled*/,
-                                        CharSourceRange /*FilenameRange*/,
-                                        const FileEntry * /*File*/,
-                                        StringRef /*SearchPath*/,
-                                        StringRef /*RelativePath*/,
-                                        const Module * /*Imported*/,
-                                        SrcMgr::CharacteristicKind /*FileType*/)
+                                             const Token &/*IncludeTok*/,
+                                             StringRef FileName,
+                                            bool /*IsAngled*/,
+                                             CharSourceRange /*FilenameRange*/,
+                                             const FileEntry * /*File*/,
+                                             StringRef /*SearchPath*/,
+                                             StringRef /*RelativePath*/,
+                                             const Module * /*Imported*/,
+                                             SrcMgr::CharacteristicKind /*FileType*/)
 {
   if (!SrcManager.isInMainFile(HashLoc))
     return;
diff --git a/clang_delta/RemoveUnusedEnumMember.cpp b/clang_delta/RemoveUnusedEnumMember.cpp
index 469db3f..fbce87a 100644
--- a/clang_delta/RemoveUnusedEnumMember.cpp
+++ b/clang_delta/RemoveUnusedEnumMember.cpp
@@ -99,15 +99,13 @@ void RemoveUnusedEnumMember::removeEnumConstantDecl()
 {
   SourceLocation StartLoc = (*TheEnumIterator)->getLocStart();
   if (StartLoc.isMacroID()) {
-    CharSourceRange CSRange =
-      SrcManager->getExpansionRange(StartLoc);
-    StartLoc = CSRange.getBegin();
+    CharSourceRange Range = SrcManager->getExpansionRange(StartLoc);
+    StartLoc = Range.getBegin();
   }
   SourceLocation EndLoc = (*TheEnumIterator)->getLocEnd();
   if (EndLoc.isMacroID()) {
-    CharSourceRange CSRange =
-      SrcManager->getExpansionRange(EndLoc);
-    EndLoc = CSRange.getEnd();
+    CharSourceRange Range = SrcManager->getExpansionRange(EndLoc);
+    EndLoc = Range.getEnd();
   }
   SourceLocation CommaLoc = Lexer::findLocationAfterToken(
     EndLoc, tok::comma, *SrcManager, Context->getLangOpts(),
diff --git a/configure b/configure
index 8887357..32267f1 100755
--- a/configure
+++ b/configure
@@ -15852,7 +15852,7 @@ fi
     as_fn_error $? "LLVM is required but program \`llvm-config' cannot be found in $with_llvm_path" "$LINENO" 5
   fi
 
-  if test -n "6.0"; then
+  if test -n "7.0"; then
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for LLVM version" >&5
 $as_echo_n "checking for LLVM version... " >&6; }
     LLVM_VERSION=`$LLVM_CONFIG --version`
@@ -15877,7 +15877,7 @@ $as_echo "$LLVM_VERSION" >&6; }
                      -e 's/[^0-9]//g'`
 
 
-  ax_compare_version_B=`echo "6.0" | sed -e 's/\([0-9]*\)/Z\1Z/g' \
+  ax_compare_version_B=`echo "7.0" | sed -e 's/\([0-9]*\)/Z\1Z/g' \
                      -e 's/Z\([0-9]\)Z/Z0\1Z/g' \
                      -e 's/Z\([0-9][0-9]\)Z/Z0\1Z/g' \
                      -e 's/Z\([0-9][0-9][0-9]\)Z/Z0\1Z/g' \
@@ -15892,7 +15892,7 @@ x$ax_compare_version_B" | sed 's/^ *//' | sort -r | sed "s/x${ax_compare_version
     if test "$ax_compare_version" = "true" ; then
     :
     else
-        as_fn_error $? "LLVM version 6.0 or later is required" "$LINENO" 5
+        as_fn_error $? "LLVM version 7.0 or later is required" "$LINENO" 5
 
   fi
 
diff --git a/configure.ac b/configure.ac
index a2de73b..e236ff9 100644
--- a/configure.ac
+++ b/configure.ac
@@ -37,7 +37,7 @@ AM_PROG_CC_C_O
 AC_PROG_CXX
 AC_PROG_LIBTOOL
 
-AX_LLVM([6.0],[engine])
+AX_LLVM([7.0],[engine])
 AX_CLANG
 
 # Handle configure-time choice of assertion-checking method.
diff --git a/scripts/travis_deps.sh b/scripts/travis_deps.sh
index 0600bf0..9fab08d 100755
--- a/scripts/travis_deps.sh
+++ b/scripts/travis_deps.sh
@@ -28,23 +28,23 @@ apt-get install -y -qq \
     software-properties-common \
     wget
 
-# Set up for installing LLVM 6.0.
+# Set up for installing LLVM 7.0
 # See <https://wiki.ubuntu.com/ToolChain>.
 # See <http://llvm.org/apt/>.
 add-apt-repository -y \
     ppa:ubuntu-toolchain-r/test
 add-apt-repository -y \
-    'deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-6.0 main'
+    'deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-7 main'
 wget -O - http://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
 apt-get update -qq
 
-# Install LLVM 6.0.  See file "INSTALL".
+# Install LLVM 7.0.  See file "INSTALL".
 apt-get install -y -qq \
-    llvm-6.0 \
-    llvm-6.0-dev \
-    clang-6.0 \
-    libclang-6.0-dev \
-    clang-format-6.0 \
+    llvm-7 \
+    llvm-7-dev \
+    clang-7 \
+    libclang-7-dev \
+    clang-format-7 \
     libedit-dev
 
 # Install other C-Reduce dependencies.  See file "INSTALL".
-- 
2.21.0

