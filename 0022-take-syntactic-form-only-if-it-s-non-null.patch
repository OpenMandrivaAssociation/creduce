From eca4f38e3de0b2df3de2ba014902f5b2549ee638 Mon Sep 17 00:00:00 2001
From: Yang Chen <chenyang@cs.utah.edu>
Date: Mon, 5 Nov 2018 21:23:33 -0800
Subject: [PATCH 22/31] take syntactic form only if it's non-null

---
 clang_delta/RemoveUnusedStructField.cpp               |  2 +-
 .../tests/remove-unused-field/unused_field3.cpp       | 11 +++++++++++
 2 files changed, 12 insertions(+), 1 deletion(-)
 create mode 100644 clang_delta/tests/remove-unused-field/unused_field3.cpp

diff --git a/clang_delta/RemoveUnusedStructField.cpp b/clang_delta/RemoveUnusedStructField.cpp
index 66d210d..44b596f 100644
--- a/clang_delta/RemoveUnusedStructField.cpp
+++ b/clang_delta/RemoveUnusedStructField.cpp
@@ -303,7 +303,7 @@ void RemoveUnusedStructField::getInitExprs(const Type *Ty,
   // Extract it's syntactic form in such case.
   bool HasDesignatedInit = false;
   if (ILE->isSemanticForm()) {
-    ILE = ILE->getSyntacticForm();
+    ILE = ILE->getSyntacticForm() == nullptr ? ILE : ILE->getSyntacticForm();
     for (unsigned I = 0; I < ILE->getNumInits(); I++) {
       if (isa<DesignatedInitExpr>(ILE->getInit(I))) {
         HasDesignatedInit = true;
diff --git a/clang_delta/tests/remove-unused-field/unused_field3.cpp b/clang_delta/tests/remove-unused-field/unused_field3.cpp
new file mode 100644
index 0000000..8738588
--- /dev/null
+++ b/clang_delta/tests/remove-unused-field/unused_field3.cpp
@@ -0,0 +1,11 @@
+// RUN: %clang_delta --transformation=remove-unused-field --counter=1 %s 2>&1 | %remove_lit_checks | FileCheck %s
+
+// CHECK: void foo() {
+void foo() {
+// CHECK: struct {
+  struct {
+    int m;
+// CHECK: } a[] = {};
+  } a[] = {1};
+// CHECK: }
+}
-- 
2.21.0

