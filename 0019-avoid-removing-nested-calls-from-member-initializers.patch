From 2c26c5f5c84c8665625d6d03cd20b602deb1e417 Mon Sep 17 00:00:00 2001
From: Yang Chen <chenyang@cs.utah.edu>
Date: Tue, 9 Oct 2018 23:40:19 -0700
Subject: [PATCH 19/31] avoid removing nested calls from member initializers

---
 clang_delta/RemoveNestedFunction.cpp              |  3 ++-
 .../remove-nested-function/remove_nested_func1.cc | 15 +++++++++++++++
 2 files changed, 17 insertions(+), 1 deletion(-)
 create mode 100644 clang_delta/tests/remove-nested-function/remove_nested_func1.cc

diff --git a/clang_delta/RemoveNestedFunction.cpp b/clang_delta/RemoveNestedFunction.cpp
index 7666207..01d3850 100644
--- a/clang_delta/RemoveNestedFunction.cpp
+++ b/clang_delta/RemoveNestedFunction.cpp
@@ -106,7 +106,8 @@ bool RNFStatementVisitor::VisitCallExpr(CallExpr *CallE)
       return true;
   }
 
-  if ((std::find(ConsumerInstance->ValidCallExprs.begin(),
+  if (CurrentStmt &&
+      (std::find(ConsumerInstance->ValidCallExprs.begin(),
                  ConsumerInstance->ValidCallExprs.end(), CallE)
           == ConsumerInstance->ValidCallExprs.end()) &&
       !ConsumerInstance->CallExprQueue.empty()) {
diff --git a/clang_delta/tests/remove-nested-function/remove_nested_func1.cc b/clang_delta/tests/remove-nested-function/remove_nested_func1.cc
new file mode 100644
index 0000000..46a4697
--- /dev/null
+++ b/clang_delta/tests/remove-nested-function/remove_nested_func1.cc
@@ -0,0 +1,15 @@
+// RUN: %clang_delta --transformation=remove-nested-function --counter=1 %s 2>&1 | %remove_lit_checks | FileCheck %s
+
+struct S1 {
+  S1(int);
+};
+int foo();
+int bar(int);
+struct f : S1 {
+// CHECK: S1(bar(foo()))
+  f() : S1(bar(foo())) {
+// CHECK-NEXT: int __trans_tmp_1 = foo();
+// CHECK-NEXT: bar(__trans_tmp_1);
+    bar(foo());
+  }
+};
-- 
2.21.0

